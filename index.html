<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ —Ñ–æ–Ω–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VoiceCall Pro - –ì–æ–ª–æ—Å–æ–≤–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #app {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        #sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        #user-info {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        #user-info h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #nickname-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        #nickname-input:focus {
            outline: none;
            border-color: #667eea;
        }

        #room-selector {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        #room-selector h3 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #room-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 10px;
            background: white;
        }

        #room-password {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #join-room-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        #join-room-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #users-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        #users-list h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .user-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 12px;
            color: #48bb78;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            display: inline-block;
        }

        .call-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn:hover {
            transform: scale(1.1);
            background: #43a047;
        }

        .call-btn.active {
            background: #f44336;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(244, 67, 54, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        #chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #current-room-info {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        #connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f8fafc;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.me {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other {
            align-self: flex-start;
            background: white;
            color: #2d3748;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.system {
            align-self: center;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 12px;
            max-width: 90%;
            text-align: center;
            border-radius: 20px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 4px;
            color: #718096;
        }

        .message.me .message-sender {
            color: rgba(255,255,255,0.8);
        }

        #message-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        #message-form {
            display: flex;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            transition: all 0.3s;
        }

        #message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        #send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        #send-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        #send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            width: 400px;
            max-width: 90%;
            overflow: hidden;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .modal-header h2 {
            margin-bottom: 5px;
            font-size: 24px;
        }

        .modal-body {
            padding: 30px;
            text-align: center;
        }

        .caller-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            animation: pulse 2s infinite;
        }

        .caller-name {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .call-status {
            color: #718096;
            margin-bottom: 25px;
        }

        .call-timer {
            font-size: 48px;
            font-weight: 700;
            color: #2d3748;
            font-family: monospace;
            margin: 20px 0;
        }

        .call-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .call-btn-large {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 30px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .call-btn-large.accept {
            background: #4caf50;
            color: white;
        }

        .call-btn-large.accept:hover {
            background: #43a047;
            transform: scale(1.1);
        }

        .call-btn-large.decline {
            background: #f44336;
            color: white;
        }

        .call-btn-large.decline:hover {
            background: #e53935;
            transform: scale(1.1);
        }

        .call-btn-large.mute {
            background: #ff9800;
            color: white;
        }

        .call-btn-large.mute:hover {
            background: #fb8c00;
            transform: scale(1.1);
        }

        .call-btn-large.mute.active {
            background: #f44336;
        }

        .call-btn-large.end {
            background: #f44336;
            color: white;
        }

        .call-btn-large.end:hover {
            background: #e53935;
            transform: scale(1.1);
        }

        .call-quality {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 15px;
        }

        .quality-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quality-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #fbbf24, #f44336);
            transition: width 0.3s;
        }

        .quality-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #718096;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞ */
        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
            margin: 10px 0;
        }

        .voice-bar {
            width: 5px;
            height: 100%;
            background: #667eea;
            border-radius: 3px;
            transition: height 0.1s;
        }

      

/* –ù–∞—á–∏–Ω–∞—é—Ç—Å—è —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è */
#message-input-area form {
    display: flex;
    align-items: center;
    gap: 10px;
}

.attach-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.attach-btn:hover {
    background: #5a6268;
    transform: scale(1.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ */
.message.file-message {
    cursor: pointer;
    background: #f0f4f8;
    border: 1px solid #e2e8f0;
}

.message.file-message:hover {
    background: #e6edf5;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.file-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
}

.file-icon {
    font-size: 32px;
    min-width: 50px;
    text-align: center;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 5px;
    word-break: break-word;
}

.file-size {
    font-size: 12px;
    color: #718096;
    margin-bottom: 5px;
}

.file-type {
    font-size: 11px;
    color: #a0aec0;
    text-transform: uppercase;
}

.file-thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.download-progress {
    width: 100%;
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: #667eea;
    width: 0%;
    transition: width 0.3s;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
.image-preview-content,
.pdf-preview-content,
.doc-preview-content {
    max-width: 90%;
    max-height: 90vh;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0,0,0,0.1);
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.close-modal:hover {
    background: rgba(0,0,0,0.2);
    transform: scale(1.1);
}

.modal-footer {
    padding: 15px;
    border-top: 1px solid #e9ecef;
    text-align: center;
}

.download-btn {
    padding: 10px 25px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s;
}

.download-btn:hover {
    background: #5a67d8;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
.upload-progress-overlay {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    z-index: 2000;
    min-width: 250px;
}

.upload-item {
    margin-bottom: 10px;
}

.upload-filename {
    font-size: 12px;
    margin-bottom: 5px;
    color: #2d3748;
}

.upload-progress-bar {
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    overflow: hidden;
}

.upload-progress-fill {
    height: 100%;
    background: #667eea;
    transition: width 0.3s;
}

/* –ó–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è */

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ */
.file-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-left: 15px;
}

.file-download-btn,
.file-preview-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.file-download-btn {
    color: #4caf50;
}

.file-download-btn:hover {
    background: #4caf50;
    color: white;
    transform: scale(1.1);
}

.file-preview-btn {
    color: #667eea;
}

.file-preview-btn:hover {
    background: #667eea;
    color: white;
    transform: scale(1.1);
}

.file-thumbnail {
    cursor: pointer;
    transition: all 0.3s;
}

.file-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è */
.attach-btn:disabled {
    background: #cbd5e0 !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
    transform: none !important;
    pointer-events: none;
}

.attach-btn:disabled:hover {
    background: #cbd5e0 !important;
    transform: none !important;
    box-shadow: none !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ file input */
#file-input:disabled {
    cursor: not-allowed;
    pointer-events: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è */
.attach-btn:disabled {
    background: #cbd5e0 !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
    transform: none !important;
    pointer-events: none;
}

.attach-btn:disabled:hover {
    background: #cbd5e0 !important;
    transform: none !important;
    box-shadow: none !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ file input */
#file-input:disabled {
    cursor: not-allowed;
    pointer-events: none;
}

   /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    #app {
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        border-radius: 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: 100%;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    body {
        padding: 0;
        overflow: hidden;
    }

    /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –í–°–ï–ì–î–ê –ü–ï–†–í–ê–Ø */
    #sidebar {
        width: 100%;
        height: auto;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #e9ecef;
        background: #f8f9fa;
        flex-shrink: 0;
        overflow: visible;
        transition: none;
        order: 1;
        position: relative;
        z-index: 10;
    }

    /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –í–°–ï–ì–î–ê –í–¢–û–†–ê–Ø */
    #main {
        height: auto;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow: visible;
        order: 2;
        position: relative;
        z-index: 5;
        margin-top: 0; /* –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ - –£–ú–ï–ù–¨–®–ê–ï–ú –í–´–°–û–¢–£, –ù–û –®–†–ò–§–¢ –û–°–¢–ê–í–õ–Ø–ï–ú */
    #chat-header {
        padding: 8px 12px; /* –£–º–µ–Ω—å—à–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        flex-shrink: 0;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
        min-height: 45px; /* –§–∏–∫—Å–∏—Ä—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    #current-room-info {
        font-size: 18px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        font-weight: 600;
        color: #2d3748;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }

    #connection-status {
        margin-top: 0;
        display: flex;
        align-items: center;
    }

    .status-badge {
        padding: 4px 8px;
        font-size: 11px;
        line-height: 1.3;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chat-messages {
        flex: none;
        min-height: 150px;
        max-height: 25vh;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch;
        padding: 10px;
        scroll-behavior: smooth;
        height: auto;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .message {
        max-width: 85%;
        padding: 8px 12px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        font-size: 14px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        margin-bottom: 6px;
        line-height: 1.4;
    }

    /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ */
    #message-input-area {
        padding: 12px 15px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        flex-shrink: 0;
        background: white;
        border-top: 1px solid #e9ecef;
        margin-top: auto;
    }

    #message-form {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #message-input {
        padding: 12px 15px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        font-size: 16px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        border-radius: 25px;
        min-height: 44px;
    }

    #send-btn, .attach-btn {
        width: 44px;
        height: 44px;
        min-width: 44px;
        font-size: 20px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
    }

    /* –í–ê–ñ–ù–û! –ü–û–õ–Ø –í–°–ï–ì–î–ê –í–ò–î–ù–´ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
    #user-info, #room-selector, #users-list {
        padding: 15px 15px 12px 15px;
        position: relative;
        z-index: 20;
        background: #f8f9fa; /* –§–æ–Ω –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ */
        border-bottom: 1px solid #e9ecef;
    }

    #user-info h3, #room-selector h3, #users-list h3 {
        font-size: 14px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        margin-bottom: 10px;
    }

    #nickname-input, #room-select, #room-password {
        padding: 12px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        font-size: 14px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        margin-bottom: 10px;
        border-width: 2px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω—é—é —Ç–æ–ª—â–∏–Ω—É */
    }

    #join-room-btn {
        padding: 12px; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        font-size: 16px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        margin-bottom: 8px;
    }

    /* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
    #users-container {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 10px;
        padding: 10px 0;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x mandatory;
    }

    .user-item {
        flex: 0 0 auto;
        width: 75px; /* –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º */
        flex-direction: column;
        text-align: center;
        padding: 8px 4px;
        scroll-snap-align: start;
        background: white;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        margin-right: 0;
        margin-bottom: 6px;
        font-size: 16px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
    }

    .user-name {
        font-size: 12px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 67px;
    }

    .user-status {
        font-size: 10px; /* –û–°–¢–ê–í–õ–Ø–ï–ú –ü–†–ï–ñ–ù–ò–ô –†–ê–ó–ú–ï–† */
        justify-content: center;
    }

    .call-btn {
        width: 28px;
        height: 28px;
        font-size: 13px;
        margin-top: 4px;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal-content {
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
        margin: 10px;
    }

    /* –§–∞–π–ª–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .file-preview {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 8px;
    }

    .file-thumbnail {
        width: 100%;
        height: auto;
        max-height: 120px;
        object-fit: cover;
        margin-bottom: 5px;
    }

    .file-icon {
        font-size: 28px;
        min-width: 40px;
    }

    .file-name {
        font-size: 13px;
    }

    .file-size, .file-type {
        font-size: 11px;
    }

    .file-actions {
        flex-direction: row;
        margin-left: 0;
        margin-top: 5px;
        width: 100%;
        justify-content: flex-end;
        gap: 8px;
    }

    .file-download-btn,
    .file-preview-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .upload-progress-overlay {
        bottom: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        width: auto;
    }
}

 

   




/* –ê–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) and (orientation: landscape) {
    #sidebar {
        max-height: 40vh;
    }

    #main {
        height: 60vh;
    }

    #chat-messages {
        height: calc(60vh - 100px);
        max-height: calc(60vh - 100px);
    }

    .user-item {
        width: 70px;
    }
}



/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 360px) {
    #chat-header {
        padding: 5px 10px;
    }
    
    #current-room-info {
        font-size: 13px;
    }
    
    #user-info, #room-selector {
        padding: 10px;
    }
    
    #users-container {
        gap: 5px;
    }
    
    .user-item {
        width: 60px;
    }
}

/* –ê–ë–°–û–õ–Æ–¢–ù–ê–Ø –ó–ê–©–ò–¢–ê - –ù–ò–ö–ê–ö–ò–• –ù–ê–õ–û–ñ–ï–ù–ò–ô */
@media (max-width: 768px) {
    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—è–µ–º –±–ª–æ–∫–∏ */
    #sidebar {
        margin-bottom: 5px;
        border-bottom: 2px solid #667eea; /* –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
    }
    
    #chat-header {
        margin-top: 0;
        border-top: 2px solid #667eea; /* –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
    }
    
    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –ø–æ–ª—è –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—É—é –≤—ã—Å–æ—Ç—É */
    #user-info, #room-selector {
        padding-top: 15px !important;
        padding-bottom: 15px !important;
    }
    
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—è */
    #users-list {
        padding-bottom: 15px !important;
        border-bottom: 2px solid #dee2e6;
    }
}

/* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 480px) {
    #chat-header {
        min-height: 40px;
        padding: 5px 10px;
    }
    
    #user-info, #room-selector, #users-list {
        padding: 12px 12px 10px 12px !important;
    }
    
    #users-container {
        gap: 8px;
    }
    
    .user-item {
        width: 70px;
    }
}

/* –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ */
@media (max-width: 360px) {
    #chat-header {
        min-height: 38px;
        padding: 3px 8px;
    }
    
    #user-info, #room-selector, #users-list {
        padding: 10px 10px 8px 10px !important;
    }
    
    .user-item {
        width: 65px;
    }
}



    </style>
</head>
<body>
    <div id="app">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="sidebar">
           
            <div id="user-info">
                <h3>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <input type="text" id="nickname-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫" maxlength="20" value="–ì–æ—Å—Ç—å">
            </div>

            <div id="room-selector">
                <h3>–ö–æ–º–Ω–∞—Ç–∞</h3>
                <select id="room-select">
                    <option value="0">üö™ –ü—Ä–∏—Ö–æ–∂–∞—è (–∫–æ–º–Ω–∞—Ç–∞ 0)</option>
                    <option value="1">–ö–æ–º–Ω–∞—Ç–∞ 1</option>
                    <option value="2">–ö–æ–º–Ω–∞—Ç–∞ 2</option>
                    <option value="3">–ö–æ–º–Ω–∞—Ç–∞ 3</option>
                    <option value="4">–ö–æ–º–Ω–∞—Ç–∞ 4</option>
                    <option value="5">–ö–æ–º–Ω–∞—Ç–∞ 5</option>
                    <option value="6">–ö–æ–º–Ω–∞—Ç–∞ 6</option>
                    <option value="7">–ö–æ–º–Ω–∞—Ç–∞ 7</option>
                    <option value="8">–ö–æ–º–Ω–∞—Ç–∞ 8</option>
                    <option value="9">–ö–æ–º–Ω–∞—Ç–∞ 9</option>
                </select>
                <input type="password" id="room-password" placeholder="–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)">
                <button id="join-room-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>

            <div id="users-list">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div id="users-container"></div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div id="main">
            <div id="chat-header">
                <div id="current-room-info">üö™ –ü—Ä–∏—Ö–æ–∂–∞—è (–∫–æ–º–Ω–∞—Ç–∞ 0)</div>
                <div id="connection-status">
                    <span class="status-badge disconnected" id="status-badge">–û—Ç–∫–ª—é—á–µ–Ω</span>
                </div>
            </div>

            <div id="chat-messages"></div>

            


            <div id="message-input-area">
    <form id="message-form" onsubmit="return false;">
        <div id="file-input-area" style="display: flex; align-items: center; margin-right: 10px;">
            <button type="button" id="attach-file-btn" class="attach-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
            <input type="file" id="file-input" style="display: none;" multiple>
        </div>
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        <button type="submit" id="send-btn" disabled>‚û§</button>
    </form>
</div>










        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
    <div id="incoming-call-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h2>
            </div>
            <div class="modal-body">
                <div class="caller-avatar" id="incoming-caller-avatar">üë§</div>
                <div class="caller-name" id="incoming-caller-name"></div>
                <div class="call-status">–ñ–µ–ª–∞–µ—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –≤–∞–º–∏</div>
                <div class="call-controls">
                    <button class="call-btn-large accept" onclick="acceptCall()">üìû</button>
                    <button class="call-btn-large decline" onclick="declineCall()">‚ùå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<div id="image-preview-modal" class="modal">
    <div class="modal-content image-preview-content">
        <div class="modal-header">
            <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
            <button class="close-modal" onclick="closeImagePreview()" title="–ó–∞–∫—Ä—ã—Ç—å (ESC)">‚úñ</button>
        </div>
        <div class="modal-body image-preview-body">
            <img id="preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 55vh;">
        </div>
        <div class="modal-footer">
            <button class="download-btn" onclick="downloadCurrentFile()">üì• –°–∫–∞—á–∞—Ç—å</button>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF -->
<div id="pdf-preview-modal" class="modal">
    <div class="modal-content pdf-preview-content" style="width: 800px; max-width: 95%;">
        <div class="modal-header">
            <h2>üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä PDF</h2>
            <button class="close-modal" onclick="closePdfPreview()" title="–ó–∞–∫—Ä—ã—Ç—å (ESC)">‚úñ</button>
        </div>
        <div class="modal-body" style="height: 50vh;">
            <iframe id="pdf-preview" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-footer">
            <button class="download-btn" onclick="downloadCurrentFile()">üì• –°–∫–∞—á–∞—Ç—å</button>
        </div>
    </div>
</div>








<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
<div id="doc-preview-modal" class="modal">
    <div class="modal-content doc-preview-content">
        <div class="modal-header">
            <h2>üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
            <button class="close-modal" onclick="closeDocPreview()" title="–ó–∞–∫—Ä—ã—Ç—å (ESC)">‚úñ</button>
        </div>
        <div class="modal-body">
            <div id="doc-info" style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;" id="doc-icon">üìÑ</div>
                <div id="doc-name" style="font-size: 18px; font-weight: bold; margin-bottom: 10px;"></div>
                <div id="doc-size" style="color: #666; margin-bottom: 20px;"></div>
                <div id="doc-type" style="color: #666; margin-bottom: 20px;"></div>
                <button class="download-btn" onclick="downloadCurrentFile()">üì• –°–∫–∞—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
            </div>
        </div>
    </div>
</div>






    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
    <div id="active-call-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé§ –ê–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫</h2>
            </div>
            <div class="modal-body">
                <div class="caller-avatar" id="active-caller-avatar">üé§</div>
                <div class="caller-name" id="active-caller-name"></div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ–ª–æ—Å–∞ -->
                <div class="voice-indicator" id="voice-indicator">
                    <div class="voice-bar" style="height: 5px;"></div>
                    <div class="voice-bar" style="height: 10px;"></div>
                    <div class="voice-bar" style="height: 15px;"></div>
                    <div class="voice-bar" style="height: 20px;"></div>
                    <div class="voice-bar" style="height: 25px;"></div>
                    <div class="voice-bar" style="height: 30px;"></div>
                    <div class="voice-bar" style="height: 25px;"></div>
                    <div class="voice-bar" style="height: 20px;"></div>
                    <div class="voice-bar" style="height: 15px;"></div>
                    <div class="voice-bar" style="height: 10px;"></div>
                    <div class="voice-bar" style="height: 5px;"></div>
                </div>

                <div class="call-timer" id="call-timer">00:00</div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏ -->
                <div class="call-quality">
                    <div class="quality-indicator">
                        <span>üì∂ –ö–∞—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∏:</span>
                        <div class="quality-bar">
                            <div class="quality-fill" id="quality-fill" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div class="quality-stats">
                        <span id="connection-type">P2P</span>
                        <span id="bitrate">64 kbps</span>
                        <span id="packet-loss">0%</span>
                    </div>
                </div>

                <div class="call-controls">
                    <button class="call-btn-large mute" id="mute-btn" onclick="toggleMute()">üîä</button>
                    <button class="call-btn-large end" onclick="endCall()">üìû</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
           // wsUrl: 'ws://localhost:3000',
            
           wsUrl: 'wss://chat-server-138b.onrender.com',  // WebSocket —Å–µ—Ä–≤–µ—Ä
            
            // STUN —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            stunServers: [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302',
                'stun:stun2.l.google.com:19302',
                'stun:stun3.l.google.com:19302',
                'stun:stun4.l.google.com:19302',
                'stun:stun.1und1.de:3478',
                'stun:stun.12connect.com:3478',
                'stun:stun.12voip.com:3478'
            ],
            
            // TURN —Å–µ—Ä–≤–µ—Ä (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï)
            turnServer: {
                urls: ['turn:openrelay.metered.ca:80'],
                username:  'openrelayproject',
                credential: 'openrelayproject'
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
            audioConstraints: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 48000,
                sampleSize: 16,
                channelCount: 1,
                latency: 0.01
            },
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WebRTC –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
            webrtcConfig: {
                iceCandidatePoolSize: 10,
                iceTransportPolicy: 'all',
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require',
                iceServers: [] // –ó–∞–ø–æ–ª–Ω–∏–º –Ω–∏–∂–µ
            }
        };

        // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ICE —Å–µ—Ä–≤–µ—Ä–æ–≤
        CONFIG.webrtcConfig.iceServers = [
            ...CONFIG.stunServers.map(url => ({ urls: url })),
            CONFIG.turnServer
        ];

        
       // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let ws = null;
let userId = Math.random().toString(36).substr(2, 9);
let userNick = localStorage.getItem('voiceChatNick') || '–ì–æ—Å—Ç—å';
let currentRoom = 0;
let users = new Map(); // userId -> { nick, inCall }
let lastPongTime = Date.now();

// ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –£–õ–£–ß–®–ï–ù–ù–û–ì–û WEBSOCKET ==========
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 10;
const RECONNECT_DELAY = 3000;
let reconnectTimer = null;
let isManualDisconnect = false;
let connectionCheckInterval = null;
let isConnected = false;
let connectionTimeout = null;
let lastMessageTime = Date.now();
let connectionCheckTimer = null;
        
        // WebRTC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let peerConnection = null;
        let localStream = null;
        let remoteStream = null;
        let currentCaller = null;
        let callStartTime = null;
        let callTimerInterval = null;
        let isMuted = false;
        let audioContext = null;
        let analyser = null;
        let mediaStreamSource = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const nicknameInput = document.getElementById('nickname-input');
        const roomSelect = document.getElementById('room-select');
        const roomPassword = document.getElementById('room-password');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const currentRoomInfo = document.getElementById('current-room-info');
        const statusBadge = document.getElementById('status-badge');
        const usersContainer = document.getElementById('users-container');
        
        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const incomingCallModal = document.getElementById('incoming-call-modal');
        const activeCallModal = document.getElementById('active-call-modal');
        const incomingCallerName = document.getElementById('incoming-caller-name');
        const activeCallerName = document.getElementById('active-caller-name');
        const callTimer = document.getElementById('call-timer');
        const muteBtn = document.getElementById('mute-btn');
        const qualityFill = document.getElementById('quality-fill');
        const connectionType = document.getElementById('connection-type');
        const bitrate = document.getElementById('bitrate');
        const packetLoss = document.getElementById('packet-loss');

    

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        nicknameInput.value = userNick;

        // ========== –§–£–ù–ö–¶–ò–ò UI ==========
        function addMessage(text, type = 'system', sender = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            
            if (type === 'other' && sender) {
                const senderDiv = document.createElement('div');
                senderDiv.classList.add('message-sender');
                senderDiv.textContent = sender;
                messageDiv.appendChild(senderDiv);
            }
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            messageDiv.appendChild(textSpan);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateUsersList() {
            usersContainer.innerHTML = '';
            
            for (const [id, user] of users) {
                if (id === userId) continue; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–±—è
                
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.textContent = user.nick.charAt(0).toUpperCase();
                
                const info = document.createElement('div');
                info.className = 'user-info';
                
                const name = document.createElement('div');
                name.className = 'user-name';
                name.textContent = user.nick;
                
                const status = document.createElement('div');
                status.className = 'user-status';
                
                const dot = document.createElement('span');
                dot.className = 'status-dot';
                
                status.appendChild(dot);
                status.appendChild(document.createTextNode('–í —Å–µ—Ç–∏'));
                
                info.appendChild(name);
                info.appendChild(status);
                
                const callBtn = document.createElement('button');
                callBtn.className = 'call-btn';
                callBtn.textContent = 'üìû';
                callBtn.onclick = () => startCall(id, user.nick);
                
                if (user.inCall) {
                    callBtn.classList.add('active');
                    callBtn.style.background = '#f44336';
                }
                
                userDiv.appendChild(avatar);
                userDiv.appendChild(info);
                userDiv.appendChild(callBtn);
                
                usersContainer.appendChild(userDiv);
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusBadge.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                statusBadge.className = 'status-badge connected';
            } else {
                statusBadge.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
                statusBadge.className = 'status-badge disconnected';
            }
        }

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
function updateAttachButtonState(roomNumber) {
    const attachBtn = document.getElementById('attach-file-btn');
    const fileInput = document.getElementById('file-input');
    
    if (roomNumber === 0) {
        attachBtn.disabled = true;
        attachBtn.style.background = '#cbd5e0';
        attachBtn.style.cursor = 'not-allowed';
        attachBtn.style.opacity = '0.5';
        attachBtn.title = 'üö´ –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª—ã';
        fileInput.disabled = true;
    } else {
        attachBtn.disabled = false;
        attachBtn.style.background = '#6c757d';
        attachBtn.style.cursor = 'pointer';
        attachBtn.style.opacity = '1';
        attachBtn.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª';
        fileInput.disabled = false;
    }
}

function connectToRoom(roomNumber, password = '', isReconnect = false) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    if (!isReconnect) {
        isManualDisconnect = false;
        reconnectAttempts = 0;
    }
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if (ws) {
        try {
            ws.onclose = null;
            ws.onerror = null;
            ws.close();
        } catch (e) {}
    }
    
    if (!isReconnect) {
        chatMessages.innerHTML = '';
        users.clear();
        updateUsersList();
        
        currentRoom = roomNumber;
        currentRoomInfo.textContent = roomNumber === 0 ? 'üö™ –ü—Ä–∏—Ö–æ–∂–∞—è (–∫–æ–º–Ω–∞—Ç–∞ 0)' : `–ö–æ–º–Ω–∞—Ç–∞ ${roomNumber}`;
        
        addMessage(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${roomNumber === 0 ? '–ø—Ä–∏—Ö–æ–∂–µ–π' : '–∫–æ–º–Ω–∞—Ç–µ ' + roomNumber}...`, 'system');
    }
    
    const wsUrl = `${CONFIG.wsUrl}?room=${roomNumber}&password=${encodeURIComponent(password)}&userId=${userId}`;
    ws = new WebSocket(wsUrl);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    connectionTimeout = setTimeout(() => {
        if (ws && ws.readyState !== WebSocket.OPEN) {
            ws.close();
            addMessage('‚è∞ –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'system');
            if (!isManualDisconnect) {
                attemptReconnect();
            }
        }
    }, 10000);
    
    ws.onopen = () => {
        clearTimeout(connectionTimeout);
        isConnected = true;
        updateConnectionStatus(true);
        reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
        
        if (isReconnect) {
            addMessage('‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'system');
        }
        
        addMessage(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${roomNumber === 0 ? '–ø—Ä–∏—Ö–æ–∂–µ–π' : '–∫–æ–º–Ω–∞—Ç–µ ' + roomNumber}`, 'system');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
        ws.send(JSON.stringify({
            type: 'user_joined',
            user: userId,
            nick: userNick,
            room: roomNumber
        }));
        
        // –í–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º –≤–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
        const attachFileBtn = document.getElementById('attach-file-btn');
        const fileInput = document.getElementById('file-input');
        
        if (roomNumber === 0) {
            messageInput.disabled = true;
            sendBtn.disabled = true;
            messageInput.placeholder = 'üö´ –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å';
            
            if (attachFileBtn) {
                attachFileBtn.disabled = true;
                attachFileBtn.style.background = '#cbd5e0';
                attachFileBtn.style.opacity = '0.5';
                attachFileBtn.title = 'üö´ –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª—ã';
            }
            
            if (fileInput) fileInput.disabled = true;
        } else {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
            
            if (attachFileBtn) {
                attachFileBtn.disabled = false;
                attachFileBtn.style.background = '#6c757d';
                attachFileBtn.style.opacity = '1';
                attachFileBtn.title = '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª';
            }
            
            if (fileInput) fileInput.disabled = false;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        setTimeout(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_active_users',
                    user: userId
                }));
            }
        }, 1000);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        startConnectionCheck();
    };
    
    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            lastMessageTime = Date.now();
            
            switch (data.type) {
                case 'system':
                    addMessage(data.text, 'system');
                    break;
                
                case 'pong':
                    console.log('–ü–æ–ª—É—á–µ–Ω pong –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    break;
                    
                case 'user_joined':
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    if (data.user === userId) {
                        return;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
                    if (!users.has(data.user)) {
                        users.set(data.user, { nick: data.nick, inCall: false, lastSeen: Date.now() });
                        updateUsersList();
                        addMessage(`üë§ ${data.nick} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 'system');
                    }
                    break;
                    
                case 'user_left':
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π userId
                    if (data.user === userId) {
                        console.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ');
                        return;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
                    setTimeout(() => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const user = users.get(data.user);
                        if (user && user.nick === data.nick) {
                            users.delete(data.user);
                            updateUsersList();
                            addMessage(`üë§ ${data.nick} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, 'system');
                            
                            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤ –∑–≤–æ–Ω–∫–µ
                            if (currentCaller && data.user === currentCaller.userId) {
                                endCall();
                                addMessage('üìû –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–µ—Ä–≤–∞–ª –∑–≤–æ–Ω–æ–∫', 'system');
                            }
                        }
                    }, 2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã
                    break;
                    
                case 'active_users':
                    syncUsersList(data.users);
                    break;
                    
                case 'message':
                    addMessage(data.text, data.user === userId ? 'me' : 'other', data.nick);
                    break;

                case 'file':
                    displayFileMessage(data, data.user === userId);
                    break;

                // WebRTC —Å–∏–≥–Ω–∞–ª—ã
                case 'call-offer':
                    if (data.targetUserId === userId) {
                        showIncomingCall(data.callerNick, data.offer, data.callerId);
                    }
                    break;
                    
                case 'call-answer':
                    if (data.targetUserId === userId && peerConnection) {
                        peerConnection.setRemoteDescription(data.answer);
                        startActiveCall(currentCaller.nick);
                        startQualityMonitoring();
                    }
                    break;
                    
                case 'ice-candidate':
                    if (data.targetUserId === userId && peerConnection) {
                        peerConnection.addIceCandidate(data.candidate);
                    }
                    break;
                    
                case 'call-declined':
                    if (data.targetUserId === userId) {
                        addMessage('üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'system');
                        cleanupCall();
                    }
                    break;
                    
                case 'call-ended':
                    if (data.targetUserId === userId) {
                        addMessage('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'system');
                        hideActiveCallModal();
                        cleanupCall();
                    }
                    break;
                    
                case 'user_in_call':
                    const user = users.get(data.user);
                    if (user) {
                        user.inCall = data.inCall;
                        updateUsersList();
                    }
                    break;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        }
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        if (!isReconnect) {
            addMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'system');
        }
    };
    
    ws.onclose = (event) => {
        clearTimeout(connectionTimeout);
        isConnected = false;
        stopConnectionCheck();
        updateConnectionStatus(false);
        
        console.log('WebSocket –∑–∞–∫—Ä—ã—Ç, –∫–æ–¥:', event.code, '–ø—Ä–∏—á–∏–Ω–∞:', event.reason);
        
        // –ù–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∏–ª–∏ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
        if (isManualDisconnect) {
            addMessage('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'system');
            return;
        }
        
        // –ù–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ (1000)
        if (event.code === 1000) {
            addMessage('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'system');
            return;
        }
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
        addMessage('‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'system');
        attemptReconnect();
    };
}
  
    




    




   
    
    ws.onerror = (error) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        if (!isReconnect) {
            addMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'system');
        }
    };




// ========== –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==========
function syncUsersList(activeUsers) {
    if (!activeUsers || !Array.isArray(activeUsers)) return;
    
    const now = Date.now();
    const usersToRemove = [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    for (const [id, user] of users) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–µ–±—è
        if (id === userId) continue;
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–ø–∏—Å–∫–µ
        if (!activeUsers.includes(id)) {
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
            if (!user.markedForRemoval) {
                user.markedForRemoval = now;
            } else if (now - user.markedForRemoval > 5000) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–æ–ª—å—à–µ 5 —Å–µ–∫—É–Ω–¥, —É–¥–∞–ª—è–µ–º
                usersToRemove.push({ id, user });
            }
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –º–µ—Ç–∫—É
            if (user.markedForRemoval) {
                delete user.markedForRemoval;
            }
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–ª–≥–æ
    usersToRemove.forEach(({ id, user }) => {
        users.delete(id);
        addMessage(`üë§ ${user.nick} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)`, 'system');
    });
    
    updateUsersList();
}




    
    










        

        // ========== –ì–û–õ–û–°–û–í–´–ï –ó–í–û–ù–ö–ò ==========
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º
        async function initAudio() {
    try {
        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–¥–∞–≤–ª–µ–Ω–∏—è —ç—Ö–∞
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                echoCancellationType: 'system', // –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 48000,
                sampleSize: 16,
                channelCount: 1,
                latency: 0.01
            }
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º —ç—Ö–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Ç—Ä–µ–∫–µ
        localStream.getAudioTracks().forEach(track => {
            const capabilities = track.getCapabilities?.();
            const settings = track.getSettings?.();
            
            if (capabilities && capabilities.echoCancellation) {
                track.applyConstraints({
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }).catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å constraints:', e));
            }
        });
        
        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        mediaStreamSource = audioContext.createMediaStreamSource(localStream);
        mediaStreamSource.connect(analyser);
        
        addMessage('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≥–æ—Ç–æ–≤ (—ç—Ö–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ)', 'system');
        

        return true;
        
    } catch (err) {
        // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    }
}

// ========== –ù–û–í–´–ô –ö–û–î –î–õ–Ø –§–û–ù–û–í–û–ô –†–ê–ë–û–¢–´ ==========

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã

let backgroundInterval = null;
let audioElement = null;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
function setupBackgroundAudioSupport() {
    try {
        // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞—É–¥–∏–æ —Å–µ—Å—Å–∏–∏
        if (!audioElement) {
            audioElement = new Audio();
            audioElement.loop = true;
            audioElement.volume = 0.01; // –ü–æ—á—Ç–∏ –±–µ–∑–∑–≤—É—á–Ω–æ
            
            // –°–æ–∑–¥–∞–µ–º —Ç–∏—à–∏–Ω—É –≤ base64 (1 —Å–µ–∫—É–Ω–¥–∞ —Ç–∏—à–∏–Ω—ã)
            const silentAudioBase64 = 'data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVAAAAA8AP8A/gD9APwA+wD6APkA+AD3APYA9QD0APMA8gDxAPAA7wDuAO0A7ADrAOoA6QDoAOcA5gDlAOQA4wDiA+AA';
            audioElement.src = silentAudioBase64;
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∂–µ—Å—Ç –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
            audioElement.play().catch(e => console.log('–§–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ:', e));
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
        window.backgroundAudioElement = audioElement;
        
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∞—É–¥–∏–æ:', err);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞—É–¥–∏–æ –≤ —Ñ–æ–Ω–µ
function keepAudioAlive() {
    if (!audioContext) return;
    
    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º
    if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            console.log('AudioContext –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω –≤ —Ñ–æ–Ω–µ');
        }).catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å AudioContext'));
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
    if (localStream) {
        localStream.getTracks().forEach(track => {
            if (track.kind === 'audio' && !track.enabled && !isMuted) {
                track.enabled = true;
            }
        });
    }
}



// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

// –ó–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–Ω–∞
async function requestWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω');
            });
        } else {
            console.log('Wake Lock –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥');
            startBackgroundKeepAlive();
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ Wake Lock:', err);
        startBackgroundKeepAlive();
    }
}


function startBackgroundKeepAlive() {
    if (backgroundInterval) return;
    
    backgroundInterval = setInterval(() => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∏–Ω–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'ping',
                user: userId,
                timestamp: Date.now()
            }));
        }
        
        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        keepAudioAlive();
        
    }, 5000); // –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
function stopBackgroundKeepAlive() {
    if (backgroundInterval) {
        clearInterval(backgroundInterval);
        backgroundInterval = null;
    }
}

// –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release().then(() => {
            wakeLock = null;
            console.log('Wake Lock –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω');
        }).catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è Wake Lock:', err));
    }
    stopBackgroundKeepAlive();
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º startActiveCall (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª)
const originalStartActiveCall = startActiveCall;
startActiveCall = function(nick) {
    originalStartActiveCall(nick);
    requestWakeLock();
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–∏—Ö–∏–π –∑–≤—É–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞—É–¥–∏–æ
    if (audioElement) {
        audioElement.play().catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ'));
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏
    document.addEventListener('visibilitychange', handleVisibilityChange);
};

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º endCall (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª)
const originalEndCall = endCall;
endCall = function() {
    originalEndCall();
    releaseWakeLock();
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ
    if (audioElement) {
        audioElement.pause();
        audioElement.currentTime = 0;
    }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
function handleVisibilityChange() {
    if (document.hidden) {
        console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ');
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω
        if (localStream && activeCallModal.classList.contains('active')) {
            localStream.getTracks().forEach(track => {
                if (track.kind === 'audio') {
                    track.enabled = true;
                }
            });
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (audioElement && audioElement.paused) {
                audioElement.play().catch(e => console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ'));
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            startBackgroundKeepAlive();
        }
    } else {
        console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ');
        stopBackgroundKeepAlive();
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∞—É–¥–∏–æ –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
        if (audioElement && !audioElement.paused) {
            audioElement.pause();
        }
    }
}

        












// –í—ã–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–µ —Å initAudio()









        // –°–æ–∑–¥–∞–Ω–∏–µ peer connection
        function createPeerConnection(targetUserId) {
            peerConnection = new RTCPeerConnection(CONFIG.webrtcConfig);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        targetUserId: targetUserId,
                        user: userId
                    }));
                }
            };
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const audioElement = document.createElement('audio');
                audioElement.srcObject = remoteStream;
                audioElement.autoplay = true;
                document.body.appendChild(audioElement);
            };
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞
            peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    addMessage('‚úÖ –ê—É–¥–∏–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'system');
                    updateUserCallStatus(true);
                } else if (peerConnection.connectionState === 'disconnected') {
                    addMessage('‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...', 'system');
                } else if (peerConnection.connectionState === 'failed') {
                    addMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ', 'system');
                    endCall();
                }
            };
            
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ICE —Å–æ—Å—Ç–æ—è–Ω–∏—è
            peerConnection.oniceconnectionstatechange = () => {
                console.log('ICE state:', peerConnection.iceConnectionState);
                
                if (peerConnection.iceConnectionState === 'connected') {
                    checkConnectionType();
                }
            };
        }

        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function startCall(targetUserId, targetNick) {
            if (currentRoom === 0) {
                addMessage('‚ùå –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è —Å–æ–≤–µ—Ä—à–∞—Ç—å –∑–≤–æ–Ω–∫–∏', 'system');
                return;
            }
            
            if (!await initAudio()) {
                return;
            }
            
            createPeerConnection(targetUserId);
            
            try {
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    voiceActivityDetection: true
                });
                
                await peerConnection.setLocalDescription(offer);
                
                ws.send(JSON.stringify({
                    type: 'call-offer',
                    offer: offer,
                    targetUserId: targetUserId,
                    callerId: userId,
                    callerNick: userNick,
                    user: userId
                }));
                
                currentCaller = {
                    userId: targetUserId,
                    nick: targetNick
                };
                
                addMessage(`üìû –ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetNick}...`, 'system');
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', err);
                addMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫', 'system');
                cleanupCall();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        function showIncomingCall(callerNick, offer, callerId) {
            currentCaller = {
                userId: callerId,
                nick: callerNick,
                offer: offer
            };
            
            incomingCallerName.textContent = callerNick;
            incomingCallModal.classList.add('active');
        }

        // –ü—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫
        async function acceptCall() {
            if (!await initAudio()) {
                declineCall();
                return;
            }
            
            createPeerConnection(currentCaller.userId);
            
            try {
                await peerConnection.setRemoteDescription(currentCaller.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                ws.send(JSON.stringify({
                    type: 'call-answer',
                    answer: answer,
                    targetUserId: currentCaller.userId,
                    user: userId
                }));
                
                hideIncomingCall();
                startActiveCall(currentCaller.nick);
                startQualityMonitoring();
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', err);
                addMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–≤–æ–Ω–æ–∫', 'system');
                declineCall();
            }
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function declineCall() {
            ws.send(JSON.stringify({
                type: 'call-declined',
                targetUserId: currentCaller ? currentCaller.userId : null,
                user: userId
            }));
            
            hideIncomingCall();
            cleanupCall();
            addMessage('üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'system');
        }

        // –ù–∞—á–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
        function startActiveCall(nick) {
            activeCallerName.textContent = nick;
            activeCallModal.classList.add('active');
            startCallTimer();
            startVoiceVisualization();
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function endCall() {
            ws.send(JSON.stringify({
                type: 'call-ended',
                targetUserId: currentCaller ? currentCaller.userId : null,
                user: userId
            }));
            
            hideActiveCallModal();
            hideIncomingCall();
            cleanupCall();
            updateUserCallStatus(false);
            addMessage('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'system');
        }

        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–≤–æ–Ω–∫–∞
        function cleanupCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            remoteStream = null;
            currentCaller = null;
            isMuted = false;
            
            stopCallTimer();
            stopVoiceVisualization();
            
            if (muteBtn) {
                muteBtn.textContent = 'üîä';
                muteBtn.classList.remove('active');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isMuted = !isMuted;
                    audioTrack.enabled = !isMuted;
                    
                    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
                    muteBtn.classList.toggle('active', isMuted);
                    
                    addMessage(isMuted ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω', 'system');
                }
            }
        }

        // –¢–∞–π–º–µ—Ä –∑–≤–æ–Ω–∫–∞
        function startCallTimer() {
            callStartTime = Date.now();
            callTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                callTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopCallTimer() {
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            callTimer.textContent = '00:00';
        }

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–∞
        function startVoiceVisualization() {
            if (!analyser) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            const bars = document.querySelectorAll('.voice-bar');
            
            function update() {
                if (!activeCallModal.classList.contains('active')) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞—Ä—ã
                bars.forEach((bar, index) => {
                    const height = Math.min(30, (average / 255) * 60);
                    const normalizedHeight = height * (1 - index / bars.length * 0.5);
                    bar.style.height = normalizedHeight + 'px';
                });
                
                requestAnimationFrame(update);
            }
            
            update();
        }

        function stopVoiceVisualization() {
            const bars = document.querySelectorAll('.voice-bar');
            bars.forEach(bar => {
                bar.style.height = '5px';
            });
        }

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤—è–∑–∏
        function startQualityMonitoring() {
            if (!peerConnection) return;
            
            setInterval(() => {
                if (!peerConnection || peerConnection.connectionState !== 'connected') return;
                
                peerConnection.getStats().then(stats => {
                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.kind === 'audio') {
                            // –ë–∏—Ç—Ä–µ–π—Ç
                            if (report.bytesReceived) {
                                const kbps = (report.bytesReceived * 8 / 1024 / 1000).toFixed(1);
                                bitrate.textContent = kbps + ' kbps';
                            }
                            
                            // –ü–æ—Ç–µ—Ä—è –ø–∞–∫–µ—Ç–æ–≤
                            if (report.packetsLost !== undefined && report.packetsReceived) {
                                const loss = (report.packetsLost / report.packetsReceived * 100).toFixed(1);
                                packetLoss.textContent = loss + '%';
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞
                                const quality = Math.max(0, 100 - loss * 10);
                                qualityFill.style.width = quality + '%';
                                
                                if (quality > 80) {
                                    qualityFill.style.background = '#48bb78';
                                } else if (quality > 50) {
                                    qualityFill.style.background = '#fbbf24';
                                } else {
                                    qualityFill.style.background = '#f44336';
                                }
                            }
                        }
                    });
                });
            }, 2000);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (P2P –∏–ª–∏ TURN)
        async function checkConnectionType() {
            if (!peerConnection) return;
            
            const stats = await peerConnection.getStats();
            let connectionType = 'P2P';
            
            stats.forEach(report => {
                if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                    const localCandidate = stats.get(report.localCandidateId);
                    if (localCandidate && localCandidate.candidateType === 'relay') {
                        connectionType = 'TURN';
                    }
                }
            });
            
            document.getElementById('connection-type').textContent = connectionType;
            
            if (connectionType === 'TURN') {
                addMessage('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TURN —Å–µ—Ä–≤–µ—Ä (—Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è)', 'system');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserCallStatus(inCall) {
            ws.send(JSON.stringify({
                type: 'user_in_call',
                user: userId,
                inCall: inCall
            }));
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        function hideIncomingCall() {
            incomingCallModal.classList.remove('active');
        }

        function hideActiveCallModal() {
            activeCallModal.classList.remove('active');
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('message-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const text = messageInput.value.trim();
            if (!text || currentRoom === 0 || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(JSON.stringify({
                type: 'message',
                user: userId,
                nick: userNick,
                text: text
            }));
            
            messageInput.value = '';
        });

        // –°–º–µ–Ω–∞ –Ω–∏–∫–∞
        nicknameInput.addEventListener('change', () => {
            const newNick = nicknameInput.value.trim() || '–ì–æ—Å—Ç—å';
            if (newNick !== userNick) {
                userNick = newNick;
                localStorage.setItem('voiceChatNick', userNick);
                addMessage(`–í–∞—à –Ω–∏–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${userNick}`, 'system');
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ —Å–º–µ–Ω–µ –Ω–∏–∫–∞
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'nick_changed',
                        user: userId,
                        nick: userNick
                    }));
                }
            }
        });

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
joinRoomBtn.addEventListener('click', () => {
    const room = parseInt(roomSelect.value);
    const password = roomPassword.value;
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
    isManualDisconnect = true;
    
    connectToRoom(room, password);
});










        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (incomingCallModal.classList.contains('active')) {
                    declineCall();
                } else if (activeCallModal.classList.contains('active')) {
                    endCall();
                }
            }
        });

        // –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        connectToRoom(0);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Ñ–∞–π–ª–æ–≤
setTimeout(() => {
    updateAttachButtonState(0);
}, 100);

       // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
window.addEventListener('beforeunload', () => {
    isManualDisconnect = true; // –ù–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
    }
    if (ws) {
        ws.close();
    }
    cleanupCall();
}); 
        






// –∑–¥–µ—Å—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∫–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ 
        // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –§–ê–ô–õ–û–í ==========
let currentPreviewFile = null;
let activeDownloads = new Map();
const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 MB
const ALLOWED_FILE_TYPES = {
    'image/jpeg': 'jpg',
    'image/png': 'png',
    'image/gif': 'gif',
    'image/webp': 'webp',
    'application/pdf': 'pdf',
    'application/msword': 'doc',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
    'application/vnd.ms-excel': 'xls',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
    'application/vnd.ms-powerpoint': 'ppt',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'pptx',
    'text/plain': 'txt',
    'application/rtf': 'rtf',
    'application/zip': 'zip',
    'application/x-rar-compressed': 'rar',
    'application/x-7z-compressed': '7z'
};

// –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
const attachFileBtn = document.getElementById('attach-file-btn');
const fileInput = document.getElementById('file-input');
const imagePreviewModal = document.getElementById('image-preview-modal');
const pdfPreviewModal = document.getElementById('pdf-preview-modal');
const docPreviewModal = document.getElementById('doc-preview-modal');
const previewImage = document.getElementById('preview-image');
const pdfPreview = document.getElementById('pdf-preview');
const docName = document.getElementById('doc-name');
const docSize = document.getElementById('doc-size');
const docType = document.getElementById('doc-type');

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –§–ê–ô–õ–ê–ú–ò ==========

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
function getFileIcon(fileType, fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    
    const icons = {
        // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üé®', 'webp': 'üñºÔ∏è',
        // –î–æ–∫—É–º–µ–Ω—Ç—ã
        'pdf': 'üìï', 'doc': 'üìò', 'docx': 'üìò', 'txt': 'üìÑ', 'rtf': 'üìÑ',
        // –¢–∞–±–ª–∏—Ü—ã
        'xls': 'üìä', 'xlsx': 'üìä',
        // –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
        'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
        // –ê—Ä—Ö–∏–≤—ã
        'zip': 'üóúÔ∏è', 'rar': 'üóúÔ∏è', '7z': 'üóúÔ∏è',
        // –î—Ä—É–≥–æ–µ
        'mp3': 'üéµ', 'mp4': 'üé¨', 'exe': '‚öôÔ∏è', 'psd': 'üé®'
    };
    
    return icons[ext] || 'üìé';
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
async function sendFile(file) {
    if (currentRoom === 0) {
        addMessage('‚ùå –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã', 'system');
        return;
    }
    
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        addMessage('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'system');
        return;
    }
    
    if (file.size > MAX_FILE_SIZE) {
        addMessage(`‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. ${formatFileSize(MAX_FILE_SIZE)})`, 'system');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
    showUploadProgress(file.name);
    
    try {
        // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ ArrayBuffer
        const buffer = await file.arrayBuffer();
        const base64Data = arrayBufferToBase64(buffer);
        
        // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–∞–π–ª–æ–º
        const fileMessage = {
            type: 'file',
            user: userId,
            nick: userNick,
            fileData: base64Data,
            fileName: file.name,
            fileType: file.type || 'application/octet-stream',
            fileSize: file.size,
            timestamp: Date.now()
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
        ws.send(JSON.stringify(fileMessage));
        
        
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        hideUploadProgress(file.name);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞:', error);
        addMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞', 'system');
        hideUploadProgress(file.name);
    }
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ArrayBuffer –≤ Base64
function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Base64 –≤ ArrayBuffer
function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// –§—É–Ω–∫—Ü–∏—è —Å –∫–Ω–æ–ø–∫–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

// ========== –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –§–ê–ô–õ–û–í –° –ö–ù–û–ü–ö–û–ô –°–ö–ê–ß–ò–í–ê–ù–ò–Ø ==========
function displayFileMessage(data, isMe = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', isMe ? 'me' : 'other', 'file-message');
    messageDiv.setAttribute('data-file-data', data.fileData);
    messageDiv.setAttribute('data-file-name', data.fileName);
    messageDiv.setAttribute('data-file-type', data.fileType);
    messageDiv.setAttribute('data-file-size', data.fileSize);
    
    if (!isMe && data.nick) {
        const senderDiv = document.createElement('div');
        senderDiv.classList.add('message-sender');
        senderDiv.textContent = data.nick;
        messageDiv.appendChild(senderDiv);
    }
    
    const filePreview = document.createElement('div');
    filePreview.className = 'file-preview';
    
    // –ò–∫–æ–Ω–∫–∞ —Ñ–∞–π–ª–∞
    const icon = document.createElement('div');
    icon.className = 'file-icon';
    icon.textContent = getFileIcon(data.fileType, data.fileName);
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ
    const info = document.createElement('div');
    info.className = 'file-info';
    
    const name = document.createElement('div');
    name.className = 'file-name';
    name.textContent = data.fileName;
    name.title = data.fileName;
    
    const size = document.createElement('div');
    size.className = 'file-size';
    size.textContent = formatFileSize(data.fileSize);
    
    const type = document.createElement('div');
    type.className = 'file-type';
    type.textContent = data.fileType || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø';
    
    info.appendChild(name);
    info.appendChild(size);
    info.appendChild(type);
    
    // ===== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô =====
    const actions = document.createElement('div');
    actions.className = 'file-actions';
    
    // –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–¥–ª—è –í–°–ï–• —Ñ–∞–π–ª–æ–≤)
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'file-download-btn';
    downloadBtn.innerHTML = 'üì•';
    downloadBtn.title = '–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª';
    downloadBtn.onclick = (e) => {
        e.stopPropagation();
        downloadAnyFile(data.fileData, data.fileName, data.fileType);
    };
    
    // –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ PDF)
    if (data.fileType.startsWith('image/') || data.fileType === 'application/pdf') {
        const previewBtn = document.createElement('button');
        previewBtn.className = 'file-preview-btn';
        previewBtn.innerHTML = 'üëÅÔ∏è';
        previewBtn.title = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä';
        previewBtn.onclick = (e) => {
            e.stopPropagation();
            previewFile(data);
        };
        actions.appendChild(previewBtn);
    }
    
    actions.appendChild(downloadBtn);
    
    // –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (data.fileType.startsWith('image/')) {
        const thumbnail = document.createElement('img');
        thumbnail.className = 'file-thumbnail';
        thumbnail.src = `data:${data.fileType};base64,${data.fileData}`;
        thumbnail.onclick = (e) => {
            e.stopPropagation();
            previewFile(data);
        };
        thumbnail.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        filePreview.appendChild(thumbnail);
    }
    
    filePreview.appendChild(icon);
    filePreview.appendChild(info);
    filePreview.appendChild(actions);
    messageDiv.appendChild(filePreview);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    messageDiv.ondblclick = (e) => {
        e.preventDefault();
        downloadAnyFile(data.fileData, data.fileName, data.fileType);
        
        messageDiv.style.transform = 'scale(0.98)';
        setTimeout(() => {
            messageDiv.style.transform = '';
        }, 200);
    };
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}









   

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞
function previewFile(fileData) {
    currentPreviewFile = fileData;
    
    if (fileData.fileType.startsWith('image/')) {
        previewImage.src = `data:${fileData.fileType};base64,${fileData.fileData}`;
        imagePreviewModal.classList.add('active');
    } 
    else if (fileData.fileType === 'application/pdf') {
        const blob = b64toBlob(fileData.fileData, fileData.fileType);
        const url = URL.createObjectURL(blob);
        pdfPreview.src = url;
        pdfPreviewModal.classList.add('active');
    }
    else {
        docName.textContent = fileData.fileName;
        docSize.textContent = formatFileSize(fileData.fileSize);
        docType.textContent = fileData.fileType || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø';
        docPreviewModal.classList.add('active');
    }
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Base64 –≤ Blob
function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, { type: contentType });
}

// ========== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø ==========
function downloadAnyFile(fileData, fileName, fileType) {
    try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        addMessage(`üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ "${fileName}" –Ω–∞—á–∞—Ç–æ`, 'system');
        
        // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        const blob = b64toBlob(fileData, fileType);
        
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        
        // –°–∫–∞—á–∏–≤–∞–µ–º
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // –û—á–∏—â–∞–µ–º
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
        addMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ "${fileName}"`, 'system');
    }
}
















// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
function downloadCurrentFile() {
    if (!currentPreviewFile) return;
    
    const blob = b64toBlob(currentPreviewFile.fileData, currentPreviewFile.fileType);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentPreviewFile.fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
function showUploadProgress(filename) {
    let overlay = document.getElementById('upload-progress-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'upload-progress-overlay';
        overlay.className = 'upload-progress-overlay';
        document.body.appendChild(overlay);
    }
    
    const item = document.createElement('div');
    item.className = 'upload-item';
    item.id = `upload-${filename.replace(/[^a-z0-9]/gi, '_')}`;
    
    item.innerHTML = `
        <div class="upload-filename">üì§ ${filename}</div>
        <div class="upload-progress-bar">
            <div class="upload-progress-fill" style="width: 0%"></div>
        </div>
    `;
    
    overlay.appendChild(item);
}

// –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
function updateUploadProgress(filename, progress) {
    const id = `upload-${filename.replace(/[^a-z0-9]/gi, '_')}`;
    const item = document.getElementById(id);
    if (item) {
        const fill = item.querySelector('.upload-progress-fill');
        if (fill) {
            fill.style.width = `${progress}%`;
        }
    }
}

// –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
function hideUploadProgress(filename) {
    const id = `upload-${filename.replace(/[^a-z0-9]/gi, '_')}`;
    const item = document.getElementById(id);
    if (item) {
        item.remove();
    }
    
    // –£–¥–∞–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–π, –µ—Å–ª–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const overlay = document.getElementById('upload-progress-overlay');
    if (overlay && overlay.children.length === 0) {
        overlay.remove();
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
function closeImagePreview() {
    imagePreviewModal.classList.remove('active');
    previewImage.src = '';
}

function closePdfPreview() {
    pdfPreviewModal.classList.remove('active');
    pdfPreview.src = '';
}

function closeDocPreview() {
    docPreviewModal.classList.remove('active');
}

// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –î–õ–Ø –§–ê–ô–õ–û–í ==========

// –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è
attachFileBtn.addEventListener('click', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤ –ø—Ä–∏—Ö–æ–∂–µ–π –ª–∏ –º—ã
    if (currentRoom === 0) {
        addMessage('üö´ –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª—ã', 'system');
        return;
    }
    fileInput.click();
});

// –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤
fileInput.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    
    for (const file of files) {
        await sendFile(file);
    }
    
    // –û—á–∏—â–∞–µ–º input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–µ –∂–µ —Ñ–∞–π–ª—ã —Å–Ω–æ–≤–∞
    fileInput.value = '';
});

// Drag & drop —Ñ–∞–π–ª–æ–≤
document.getElementById('chat-messages').addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatMessages.style.background = '#e3f2fd';
});

document.getElementById('chat-messages').addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatMessages.style.background = '';
});

document.getElementById('chat-messages').addEventListener('drop', async (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatMessages.style.background = '';
    
    if (currentRoom === 0) {
        addMessage('‚ùå –í –ø—Ä–∏—Ö–æ–∂–µ–π –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã', 'system');
        return;
    }
    
    const files = Array.from(e.dataTransfer.files);
    
    for (const file of files) {
        await sendFile(file);
    }
});


//–Ω–æ–≤–∞—è –¥–æ–±–∞–≤–∫–∞

// ========== –£–õ–£–ß–®–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –ó–ê–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù ==========

// –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function closeImagePreview() {
    imagePreviewModal.classList.remove('active');
    previewImage.src = ''; // –û—á–∏—â–∞–µ–º src, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
}

// –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF
function closePdfPreview() {
    pdfPreviewModal.classList.remove('active');
    pdfPreview.src = ''; // –û—á–∏—â–∞–µ–º src, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
}

// –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
function closeDocPreview() {
    docPreviewModal.classList.remove('active');
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ª—é–±–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeAllPreviews() {
    closeImagePreview();
    closePdfPreview();
    closeDocPreview();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω (–æ–≤–µ—Ä–ª–µ–π)
imagePreviewModal.addEventListener('click', (e) => {
    // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –∏–º–µ–Ω–Ω–æ –Ω–∞ —Ñ–æ–Ω (—Å–∞–º –º–æ–¥–∞–ª), –∞ –Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
    if (e.target === imagePreviewModal) {
        closeImagePreview();
    }
});

pdfPreviewModal.addEventListener('click', (e) => {
    if (e.target === pdfPreviewModal) {
        closePdfPreview();
    }
});

docPreviewModal.addEventListener('click', (e) => {
    if (e.target === docPreviewModal) {
        closeDocPreview();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
        if (imagePreviewModal.classList.contains('active')) {
            closeImagePreview();
        } else if (pdfPreviewModal.classList.contains('active')) {
            closePdfPreview();
        } else if (docPreviewModal.classList.contains('active')) {
            closeDocPreview();
        }
    }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.querySelectorAll('.modal-content').forEach(content => {
    content.addEventListener('click', (e) => {
        e.stopPropagation(); // –ù–µ –¥–∞–µ–º —Å–æ–±—ã—Ç–∏—é –¥–æ–π—Ç–∏ –¥–æ —Ñ–æ–Ω–∞
    });
});











// –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
function scrollToBottom() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
const originalAddMessage = addMessage;
addMessage = function(text, type = 'system', sender = null) {
    originalAddMessage(text, type, sender);
    setTimeout(scrollToBottom, 100);
};

















            
           
    

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
            console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);
        }).catch(err => {
            console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', err);
        });
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ —Ñ–æ–∫—É—Å–∞ (–¥–ª—è Android)
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', () => {
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    });
    
    navigator.mediaSession.setActionHandler('pause', () => {
        // –ü–∞—É–∑–∞
    });
    
    navigator.mediaSession.setActionHandler('stop', () => {
        endCall();
    });
}




// ========== –û–ë–†–ê–ë–û–¢–ö–ê –í–ò–î–ò–ú–û–°–¢–ò –°–¢–†–ê–ù–ò–¶–´ ==========
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        if ((!ws || ws.readyState !== WebSocket.OPEN) && !isManualDisconnect) {
            addMessage('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...', 'system');
            attemptReconnect();
        }
    }
});








// ========== –ü–†–û–í–ï–†–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø ==========
function startConnectionCheck() {
    stopConnectionCheck();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    connectionCheckTimer = setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping
            try {
                ws.send(JSON.stringify({ 
                    type: 'ping', 
                    user: userId,
                    timestamp: Date.now() 
                }));
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–∏—Å–ª–æ –ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (Date.now() - lastMessageTime > 60000) { // 60 —Å–µ–∫—É–Ω–¥ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
                console.log('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è');
                if (!isManualDisconnect) {
                    attemptReconnect();
                }
            }
        }
    }, 30000);
}

function stopConnectionCheck() {
    if (connectionCheckTimer) {
        clearInterval(connectionCheckTimer);
        connectionCheckTimer = null;
    }
}

// ========== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ==========
setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN && isConnected) {
        ws.send(JSON.stringify({
            type: 'get_active_users',
            user: userId
        }));
    }
}, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥


    
   






        



    </script>
</body>
</html>
